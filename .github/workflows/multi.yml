name: Scheduled Restart of SAP BTP Apps (Multi-Endpoint with Custom Orgs/Spaces)
on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©UTCæ—¶é—´3ç‚¹æ‰§è¡Œ
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  restart-apps:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # å®Œæ•´ç¯å¢ƒé…ç½®çŸ©é˜µï¼ˆæ¯ä¸ªç«¯ç‚¹ç‹¬ç«‹å®šä¹‰æ‰€æœ‰å‚æ•°ï¼‰
        environment: 
          - name: "production-sgâ€
            api_url: https://api.cf.ap21.hana.ondemand.com
            username: ${{ secrets.CF_USERNAME }}
            password: ${{ secrets.CF_PASSWORD }}
            org: "fde1f680trial"                  # ç”Ÿäº§ç¯å¢ƒOrg
            space: â€œdevâ€              # ç”Ÿäº§ç¯å¢ƒSpace
            apps: [â€œiSAPâ€, â€œs2â€]  # ç”Ÿäº§ç¯å¢ƒåº”ç”¨åˆ—è¡¨
            
          - name: "dr-us"
            api_url: https://api.cf.us10-001.hana.ondemand.com
            username: ${{ secrets.CF_USERNAME}}
            password: ${{ secrets.CF_PASSWORD }}
            org: "t2-mcekz8t8"                # ç¾å¤‡ç¯å¢ƒOrg
            space: â€œdevâ€            # ç¾å¤‡ç¯å¢ƒSpace
            apps: [â€œs3"]  # ç¾å¤‡ç¯å¢ƒåº”ç”¨åˆ—è¡¨
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf-cli

      - name: Login to ${{ matrix.environment.name }}
        env:
          CF_API_URL: ${{ matrix.environment.api_url }}
          CF_USERNAME: ${{ matrix.environment.username }}
          CF_PASSWORD: ${{ matrix.environment.password }}
          CF_ORG: ${{ matrix.environment.org }}
          CF_SPACE: ${{ matrix.environment.space }}
        run: |
          echo "ğŸ” ç™»å½•åˆ° [$CF_ORG/$CF_SPACE] @ $CF_API_URL"
          cf login -a "$CF_API_URL" -u "$CF_USERNAME" -p "$CF_PASSWORD" -o "$CF_ORG" -s "$CF_SPACE"
          cf target  # æ˜¾ç¤ºå½“å‰ç›®æ ‡è¯¦æƒ…

      - name: Restart Apps in ${{ matrix.environment.space }}
        run: |
          for app in ${{ toJSON(matrix.environment.apps) }}; do
            app=$(echo $app | tr -d '"')
            echo "ğŸ”„ é‡å¯åº”ç”¨: $app (Space: ${{ matrix.environment.space }})"
            cf restart "$app" || echo "âŒ å¤±è´¥: $app"
          done

      - name: Verify Status
        run: |
          echo "âœ… å½“å‰è¿è¡ŒçŠ¶æ€:"
          cf apps | grep -E "name|requested state"

