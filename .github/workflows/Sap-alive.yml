name: SAP-BTP 应用重启

on:
  schedule:
    - cron: '15 0 * * *'    # UTC 0:15 (北京时间 8:15)
    - cron: '25 2 * * *'    # UTC 0:50 (北京时间 8:50)
  workflow_dispatch:        # 允许手动触发

jobs:
  # 新加坡环境 - 重启 iSAP
  restart-isap-sg:
    runs-on: ubuntu-latest
    steps:
      - name: 安装 CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf8-cli

      - name: 登录并重启 iSAP (新加坡)
        env:
          CF_API: ${{ secrets.CF_API_SG }}
          CF_USER: ${{ secrets.CF_USERNAME }}
          CF_PASS: ${{ secrets.CF_PASSWORD }}
        run: |
          # 登录新加坡环境
          cf login -a "$CF_API" -u "$CF_USER" -p "$CF_PASS" -o "fde1f680trial" -s "dev" --skip-ssl-validation
          
          # 直接重启应用
          cf restart "iSAP"
          echo "✅ iSAP 重启命令已执行"

  # 美国环境 - 重启 s3
  restart-s3-us:
    runs-on: ubuntu-latest
    steps:
      - name: 安装 CF CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install -y cf8-cli

      - name: 登录并重启 s3 (美国)
        env:
          CF_API: ${{ secrets.CF_API_US }}
          CF_USER: ${{ secrets.CF_USERNAME }}
          CF_PASS: ${{ secrets.CF_PASSWORD }}
        run: |
          # 登录美国环境
          cf login -a "$CF_API" -u "$CF_USER" -p "$CF_PASS" -o "t2_t2-mcekz8t8" -s "dev" --skip-ssl-validation
          
          # 直接重启应用
          cf restart "s3"
          echo "✅ s3 重启命令已执行"
